<!DOCTYPE html>
<html>
  <head>
    <title>Track'd</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
    </style>
	  <link rel="stylesheet" href="lib/bootstrap-3.3.4/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDrfqu9Nw7UW-ZJGYvJqXP7Y3J2q1JDAkE"></script>
	<!--<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3&sensor=true&callback=init"></script>-->
	
	 
	 <!-- other page scripts -->
      

  </head>
  <body>
  
      <script>
// Note: This example requires that you consent to location sharing when
// prompted by your browser. If you see a blank space instead of the map, this
// is probably because you have denied permission for location sharing.
//create a global variable namespace based on usgs.gov
//this is how JavaScript developers keep global variables
//separate from one another when mixing code from different
//sources on the same page
var map = map || {};
//gov.usgs = gov.usgs || {};



function initialize() {
  var mapOptions = {
	scaleControl:true,
    zoom: 16
  };
  map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);

  // Try HTML5 geolocation
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = new google.maps.LatLng(position.coords.latitude,
                                       position.coords.longitude);

      map.setCenter(pos);
    }, function() {
      handleNoGeolocation(true);
    });
  } else {
    // Browser doesn't support Geolocation
    handleNoGeolocation(false);
  }
}

function handleNoGeolocation(errorFlag) {
  if (errorFlag) {
    var content = 'Error: The Geolocation service failed.';
  } else {
    var content = 'Error: Your browser doesn\'t support geolocation.';
  }

  var options = {
    map: map,
    position: new google.maps.LatLng(47.6561432, -122.3062688),
    content: content
  };

  var infowindow = new google.maps.InfoWindow(options);
	map.setCenter(options.position);
}
  google.maps.event.addDomListener(window, 'load', initialize);
  google.maps.event.addDomListener(window, "resize", function() {
	var center = map.getCenter();
	google.maps.event.trigger(map, "resize");
	map.setCenter(center); 
});
</script>


<script>

//url for events json
var eventsUrl = 'http://54.149.52.200:3000/events'

//current events dataset
var displayEvents; 

//AJAX Error event handler
//just alerts the user of the error
$(document).ajaxError(function(event, jqXHR, err){
    alert('Problem obtaining data: ' + jqXHR.statusText);
})

//$(function(){
//console.log("Should try to make connection 2");

	//getEvents();


//});

window.onload = function getEvents() {
	 $.ajax({
			type: 'GET',
			dataType: 'jsonp',
            crossDomain: true,
			headers: {          
             Accept : "application/json; charset=utf-8",         
           
			},   
           url: eventsUrl,
			success: function (data) {
					var obj = $.parseJSON(data); // convert the received response to a JSON object
					parseEvents(data);
			},
			//jsonpCallback: "parseEvents",
           // success: function(events){
				//$('.message').html('Loading... <img src="img/loading.gif">');
			//	displayEvents = events;
			//	$('.message').html('Displaying ' + events.length + ' events'); 
			//	addEventMarkers(events,map);
			//	}, 
            error: function (xhr, status, error) {
               alert("error");
            }
        });
		
	//$.getJSON(eventsUrl, 
	var infoWindow;
	//var windowWidth = 
	//var windowLength = 
	//console.log(windowWidth);
	var myIcon = new google.maps.MarkerImage("img/marker30-01.png", null, null, null, new google.maps.Size(22,31));
	event.mapMarker = new google.maps.Marker({
			map: map,
			position: new google.maps.LatLng(47.655135, -122.314765),
			icon: myIcon,
			//src: 'img/marker30-01.png'
			//scale: 20
        //fillColor: "#F00",
        //fillOpacity: 0.4,
        //strokeWeight: 0.4
			//	}
			});
			infoWindow = new google.maps.InfoWindow({
			content: "ACT"
			});
			registerInfoWindow(map, event.mapMarker, infoWindow);
	
}

function parseEvents(events){
		if (events.responseStatus == "200") {
			alert(events.event.name);
			var jsonObj = $.parseJSON(events);
			displayEvents = jsonObj;
				$('.message').html('Displaying ' + events.length + ' events'); 
				addEventMarkers(events,map);
		} else {
			alert(events.responseDetails);
		}
            
				
}
function addEventMarkers(events, map) {

	var event; //current event data
	var idx;	//loop counter
	var infoWindow; //InfoWindow for Event
	
	
	for(idx = 0; idx < events.length; ++idx) {
		event = events[idx];
		
		if(event.location){
			event.mapMarker = new google.maps.Marker({
			map: map,
			position: new google.aps.LatLng(event.location.lat, event.location.long)
			
    
			});
			infoWindow = new google.maps.InfoWindow({
			content: new string(event.title).toLocaleString()
			});
			registerInfoWindow(map, event.mapMarker, infoWindow);
		}
	}
}
function registerInfoWindow(map, marker, infoWindow) {
	var iw = infoWindow; 
	//marker.setIcon('img/marker30-01.png'); 
	google.maps.event.addListener(marker, 'click', function(){
		if(iw){
		 iw.close; 
		}
		iw = infoWindow;
		infoWindow.open(map, marker);
	});
	
	google.maps.event.addListener(marker, 'mouseover', function() {
	 if(iw){
		 iw.close; 
		}
		iw = infoWindow;
		infoWindow.open(map, marker);
		
	});

	google.maps.event.addListener(marker, 'mouseout', function() {
    console.log("hello")
    iw.close();
	});
	 
	 
}



/**
var mysql = require('mysql');
var conn  = mysql.createConnection({
  host      : "localhost",
  user      : "root",
  password  :"",
  database  : "trackd"
});

conn.connect(function(err){
	if(!err) {
		console.log("Database is connected ... \n\n");  
	} else {
		console.log("Error connecting database ... \n\n");  
	}
});
conn.query("use trackd");
conn.query('SELECT * from markers', function(err, rows, fields) {
    if (err) {
                console.log("ERROR: " + err.message);
                throw err;
            }
            console.log("Got "+results.length+" Rows:");
            console.log(results);
			 // as an example, we'll print the object as JSON
			console.log(JSON.stringify(rows, null, 2));
            //console.log("The meta data about the columns:");
            //console.log(fields);
            client.end();
	});

 conn.end(function(err){
// Do something after the connection is gracefully terminated.

});

conn.destroy( );

*/
/**var query = ' \
SELECT * from markers';

conn.query(query, function(err, rows, fields) {

  rows.forEach(function(row) {
    row.order = row.money.toString().split(',').map(function(value) {
      return { money : Number(value) };
    });
   
  });
  // as an example, we'll print the object as JSON
  console.log(JSON.stringify(rows, null, 2));
});

tableHasData = function(client)
{
    client.query(
        'SELECT * FROM markers',
        function selectCb(err, results, fields) {
            if (err) {
                console.log("ERROR: " + err.message);
                throw err;
            }
            console.log("Got "+results.length+" Rows:");
            console.log(results);
            //console.log("The meta data about the columns:");
            //console.log(fields);
            client.end();
        });
};

conn.end();
*/

 </script>
    <div id="map-canvas"></div>
	
  </body>
</html>

